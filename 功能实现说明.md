# 审批系统文件管理功能实现说明

## 1. 项目概述

本项目是一个基于React + TypeScript + Spring Boot的审批系统，主要用于处理员工的请假申请和报销申请。本次实现主要集中在文件上传、查看和下载功能上，并对相关功能进行了调整和优化。

## 2. 实现功能

### 2.1 核心功能
- **文件上传功能**：支持在请假和报销表单中上传附件
- **文件查看功能**：支持部分文件类型的在线查看
- **文件下载功能**：支持所有文件类型的下载
- **审批流程**：审批员可以查看申请详情并进行审批
- **历史记录**：员工可以查看自己的申请历史和审批结果

### 2.2 支持的文件类型
最终版本只支持文档类型：
- `.pdf` - PDF文档
- `.doc, .docx` - Word文档
- `.xls, .xlsx` - Excel表格

## 3. 技术栈

### 3.1 前端
- **React 18** - 前端框架
- **TypeScript** - 类型安全
- **Tailwind CSS** - 样式框架
- **Zustand** - 状态管理
- **Axios** - API请求
- **Lucide React** - 图标库

### 3.2 后端
- **Spring Boot** - 后端框架
- **MyBatis Plus** - ORM框架
- **MySQL** - 数据库

## 4. 文件结构

### 4.1 前端核心文件
```
frontend/src/
├── components/ui/
│   ├── FileUpload.tsx      # 文件上传组件
│   └── FileViewer.tsx      # 文件查看组件
└── pages/
    ├── Approver/
    │   └── TodoTasks.tsx   # 审批员待办任务页面
    ├── MyApplications.tsx  # 我的申请页面
    └── User/
        ├── ApprovalHistory.tsx  # 审批历史页面
        ├── CreateLeave.tsx      # 创建请假申请页面
        └── CreateReimburse.tsx  # 创建报销申请页面
```

### 4.2 后端核心文件
```
approval-backend/src/main/java/com/approval/
└── module/approval/
    ├── controller/
    │   └── ApplicationController.java  # 申请管理控制器
    ├── service/impl/
    │   ├── ApplicationServiceImpl.java  # 申请服务实现
    │   └── TaskServiceImpl.java        # 任务服务实现
    └── dto/
        ├── CreateLeaveDto.java         # 创建请假申请DTO
        └── CreateReimburseDto.java     # 创建报销申请DTO
```

### 4.3 数据库文件
```
sql/
├── 01-create-tables.sql      # 数据库表创建脚本
├── 02-init-data.sql          # 初始数据脚本
└── 03-update-file-fields.sql # 文件字段更新脚本
```

## 5. 核心功能说明

### 5.1 文件上传组件 (FileUpload.tsx)

**功能**：用于表单中的文件上传

**主要参数**：
- `acceptedTypes`：支持的文件类型，默认为`.pdf, .doc, .docx, .xls, .xlsx`
- `maxSize`：最大文件大小（MB），默认为10MB
- `useBase64`：是否使用Base64编码上传，默认为false
- `required`：是否必填，默认为false

**使用示例**：
```tsx
<FileUpload
    id="leave-attachment"
    label="附件"
    acceptedTypes=".pdf, .doc, .docx"
    maxSize={5}
    value={form.attachment}
    onChange={(value) => setForm({ ...form, attachment: value })}
    required={false}
    useBase64={true}
/>
```

### 5.2 文件查看组件 (FileViewer.tsx)

**功能**：用于查看和下载已上传的文件

**主要参数**：
- `fileName`：文件名
- `fileUrl`：文件URL（可选）
- `fileContent`：Base64编码的文件内容（可选）

**支持在线查看的文件类型**：
- 图片：`jpg, jpeg, png, gif, webp`
- 文档：`pdf`
- 文本：`txt, html, css, js, json`

### 5.3 审批流程

1. **员工提交申请**：员工填写请假或报销表单，上传附件，提交申请
2. **审批员处理**：审批员在待办任务页面查看申请详情，包括附件
3. **审批操作**：审批员可以选择同意或拒绝申请
4. **结果反馈**：员工可以在申请历史页面查看审批结果

## 6. 修改历史

### 6.1 主要修改记录

| 时间 | 修改内容 | 修改文件 |
|------|----------|----------|
| 2026-01-19 | 实现文件上传组件 | `frontend/src/components/ui/FileUpload.tsx` |
| 2026-01-19 | 实现文件查看组件 | `frontend/src/components/ui/FileViewer.tsx` |
| 2026-01-19 | 修复登录白屏错误 | `frontend/src/components/ui/FileUpload.tsx` |
| 2026-01-19 | 修改审批员功能 | `frontend/src/pages/Approver/TodoTasks.tsx` |
| 2026-01-19 | 调整文件格式支持 | `frontend/src/components/ui/FileUpload.tsx` |
| 2026-01-19 | 更新支持格式文字 | `frontend/src/components/ui/FileUpload.tsx` |
| 2026-01-19 | 修改请假表单 | `frontend/src/pages/User/CreateLeave.tsx` |
| 2026-01-19 | 修改报销表单 | `frontend/src/pages/User/CreateReimburse.tsx` |
| 2026-01-19 | 优化申请历史页面 | `frontend/src/pages/User/ApprovalHistory.tsx` |
| 2026-01-19 | 优化我的申请页面 | `frontend/src/pages/MyApplications.tsx` |

### 6.2 错误修复

- **登录屏幕白屏**：修复了Lucide React图标导入错误，将`CloudUpload`替换为`Upload`
- **PNG上传失败**：由于数据库字段限制，最终调整为只支持文档格式
- **文件查看失败**：优化了FileViewer组件的Base64处理逻辑

## 7. 使用说明

### 7.1 员工使用指南

1. **创建请假申请**：
   - 进入「我的申请」页面，点击「新建请假申请」
   - 填写请假信息，选择开始时间和结束时间
   - 上传附件（支持PDF、Word、Excel格式）
   - 点击「提交申请」

2. **创建报销申请**：
   - 进入「我的申请」页面，点击「新建报销申请」
   - 填写报销信息，包括金额、类别、日期
   - 上传发票附件（支持PDF、Word、Excel格式）
   - 点击「提交申请」

3. **查看申请历史**：
   - 进入「审批历史」页面，查看所有已完成的申请
   - 点击申请可以查看详情和附件

### 7.2 审批员使用指南

1. **查看待办任务**：
   - 进入「待办任务」页面，查看所有待审批的申请
   - 点击申请可以查看详情和附件

2. **处理审批**：
   - 在申请详情页面，查看完整的申请信息和附件
   - 点击「同意」或「拒绝」按钮进行审批
   - 可以添加审批意见

## 8. 注意事项

1. **文件大小限制**：上传的文件大小不能超过10MB
2. **文件类型限制**：只支持PDF、Word、Excel格式的文件
3. **Base64编码**：文件内容会以Base64格式存储在数据库中
4. **审批权限**：只有被管理员分配为审批员的用户才能查看和处理待办任务

## 9. 未来优化方向

1. **支持更多文件类型**：考虑使用文件服务器存储大文件，支持更多类型
2. **文件预览优化**：增强文件预览功能，支持更多格式的在线查看
3. **批量上传**：支持同时上传多个文件
4. **文件版本管理**：支持文件的版本控制和历史记录
5. **移动端适配**：优化移动端的文件上传和查看体验

---

**文档更新时间**：2026-01-19
**文档作者**：系统开发团队