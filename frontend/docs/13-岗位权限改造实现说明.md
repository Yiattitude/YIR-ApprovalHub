# 岗位权限改造实现说明

## 1. 背景与目标
- 系统管理员原先通过“角色”分配权限，容易造成冗余和职责不清。
- 需求要求：以“岗位”为中心绑定权限，用户只需要被分配到一个岗位即可继承对应能力。
- 后端需提供岗位-权限维护、用户岗位分配、权限查询能力；前端需配套可视化配置页面。

## 2. 数据结构调整
1. **数据库表**
   - `sys_permission`：存储权限编码、名称、描述、状态等基础信息。
   - `sys_post_permission`：岗位与权限的多对多关联表，由 `post_id` 与 `permission_id` 组成唯一键。
2. **实体与 Mapper**
   - `Permission`、`Post` 实体对应 `sys_permission`、`sys_post`。
   - `PermissionMapper` 扩展了 `selectPermissionsByPostId`、`selectPermissionCodesByPostId`、`deletePostPermissions`、`insertPostPermission`，负责岗位权限关系的增删查。

## 3. 后端业务实现
1. **岗位 CRUD 与权限绑定**（`approval-backend/src/main/java/com/approval/module/system/service/impl/AdminServiceImpl.java`）
   - `createPost`/`updatePost` 校验岗位编码唯一性后，调用 `savePostPermissions(postId, permissionIds)` 写入 `sys_post_permission`。
   - `deletePost` 会阻止删除仍有用户绑定的岗位，并清理对应的岗位权限关系。
   - `convertToPostVo` 读取岗位拥有的权限，封装到 `PostVo.permissions` 供前端展示。
2. **权限列表输出**
   - `AdminController#getAllPermissions` 暴露 `/admin/permissions/all`，结合 `PermissionVo` 提供给前端配置界面。
3. **用户岗位分配**
   - `AssignPostDto`（`dto/AssignPostDto.java`）定义用户与岗位 ID。
   - `AdminController#assignPost` 暴露 `/admin/users/post`，`AdminServiceImpl#assignPost` 校验用户、岗位存在后更新 `sys_user.post_id`。
   - `convertToUserVo` 读取岗位权限编码，便于前端在用户列表显示“实际权限”。
4. **角色相关代码清理**
   - 旧的 `AssignRolesDto` 被删除，后端不再提供角色分配入口，确保所有权限入口统一收敛到岗位模型。

## 4. 前端改造
1. **类型与 API**（`frontend/src/types/index.ts`, `frontend/src/api/admin.ts`）
   - 新增 `Permission`, `AdminPost.permissions`, `PostFormData.permissionIds`, `AssignPostData` 等类型。
   - `adminApi` 新增 `getAllPermissions`, `assignPost`，扩展岗位 CRUD。
2. **岗位管理页面**（`frontend/src/pages/Admin/PostManagement.tsx`）
   - 支持创建/编辑岗位时勾选权限清单，保存时提交 `permissionIds`。
   - 表格展示每个岗位当前绑定的权限标签，便于巡检。
3. **岗位分配页面**（`frontend/src/pages/Admin/PostAssignment.tsx`）
   - 列表展示用户并允许为其选定岗位；对话框实时回显岗位附带的权限集合，便于管理员确认授权范围。
4. **用户管理页面**（`frontend/src/pages/Admin/UserManagement.tsx`）
   - 用户表格新增“岗位”“权限”列，源自后台 `UserVo`，帮助核对最终权限结果。

## 5. 接口清单
| 模块 | 方法 | 描述 |
| --- | --- | --- |
| 后端 | `GET /admin/posts` | 分页查询岗位（含权限）。 |
| 后端 | `POST /admin/posts` | 创建岗位并绑定权限。 |
| 后端 | `PUT /admin/posts` | 更新岗位与权限。 |
| 后端 | `DELETE /admin/posts/{id}` | 删除岗位（含关系清理）。 |
| 后端 | `GET /admin/posts/all` | 获取启用的岗位列表，用于下拉框。 |
| 后端 | `GET /admin/permissions/all` | 输出全部可用权限。 |
| 后端 | `POST /admin/users/post` | 为用户分配岗位。 |

## 6. 测试建议
1. **岗位 CRUD**：创建岗位 A 并绑定多条权限，编辑后校验 `sys_post_permission` 是否同步更新。
2. **权限继承**：将用户 U 分配到岗位 A，登录后检查其菜单/按钮权限是否与 A 一致。
3. **删除保护**：为岗位 A 绑定用户 U 后尝试删除，应收到“岗位下存在用户”提示。
4. **前端联动**：在岗位管理页面修改权限后，刷新岗位分配及用户管理页面，确认权限展示同步。

以上实现满足“岗位绑定权限 + 用户分配岗位”的需求闭环，实现了权限统一治理。