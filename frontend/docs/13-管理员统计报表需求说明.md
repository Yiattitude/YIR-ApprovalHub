# 管理员统计报表需求说明

> 本文档面向 AI 或自动化实现工具，明确统计报表需求、指标口径与交互方式，便于后续自动生成或开发。

## 1. 目标概述
- 为系统管理员提供多人可视化统计能力，快速洞察部门/角色的人力规模、审批活跃度与审批效率。
- 自动生成按月、按部门的报表，并支持卡片式入口查看与下载。
- 前后端数据格式需标准化，便于 AI 接入或自动化脚本扩展。

## 2. 数据维度与指标
### 2.1 员工规模类
| 指标 | 口径说明 |
| --- | --- |
| 部门员工数 | 统计 `sys_user` 中 `dept_id` 相同且状态启用的人员数量。 |
| 角色/岗位员工数 | 可根据岗位或角色表，统计各岗位绑定的启用用户数。 |

### 2.2 审批活跃度（按月）
| 指标 | 口径说明 |
| --- | --- |
| 部门月申请总数 | `bpm_application` 按 `dept_id` 与 `app_type` 聚合；细分请假、报销。 |
| 月通过率 | 通过数 / 提交数，建议区分请假、报销；在折线图中展示趋势。 |

### 2.3 部门明细报表
- 时间维度：按月。
- 内容：
  - 每位成员的请假次数、请假总时长（天）。
  - 每位成员的报销申请数量、累计金额。
- 关联表：`bpm_leave_application`、`bpm_reimburse_application` 联合 `bpm_application`。

## 3. 报表生成要求
1. **自动化排程**：每月初（如 1 日 02:00）批量生成上一月的部门报表，存入报表表或对象存储。支持手动触发全量再生成。
2. **数据快照**：生成时记录统计口径与时间范围，避免后续数据变动影响历史报表。
3. **导出格式**：
   - JSON（供 AI 使用）。
   - 可选 PDF/Excel（供人工下载）。

## 4. 前端展示（管理员视角）
1. **仪表盘卡片区**：
   - 卡片 1：部门员工数量 Top5。
   - 卡片 2：岗位/角色员工数量。
   - 卡片 3：最近一个月的申请总数与通过率。
   - 卡片点击后进入对应图表页面。
2. **折线图**：
   - 横轴：月份。
   - 纵轴：
     - 折线 A：请假通过率。
     - 折线 B：报销通过率。
3. **部门报表页**：
   - 左侧列表：部门树。
   - 右侧显示所选月份的人员明细表格，可切换“请假”/“报销”。
   - 支持下载按钮获取单部门报表文件。

## 5. 接口与数据结构建议
### 5.1 汇总接口
```
GET /admin/reports/summary?month=2026-01
返回：
{
  "deptEmployeeStats": [{"deptId":1,"deptName":"技术部","userCount":35}],
  "postEmployeeStats": [{"postId":2,"postName":"审批经理","userCount":4}],
  "applicationStats": {
    "leave": {"total": 120, "approved": 90},
    "reimburse": {"total": 80, "approved": 60}
  }
}
```

### 5.2 报表明细接口
```
GET /admin/reports/dept-detail?deptId=1&month=2026-01
返回：
{
  "deptId":1,
  "deptName":"技术部",
  "month":"2026-01",
  "leaveDetails":[{"userId":5,"realName":"张三","times":3,"days":4.5}],
  "reimburseDetails":[{"userId":5,"realName":"张三","times":2,"amount":1500.00}]
}
```

## 6. AI 实施提示
- 优先实现后端统计服务（可用定时任务 + MyBatis 聚合查询）。
- 前端可借助图表库（ECharts / Recharts）渲染折线图与表格。
- 文档所述格式可直接作为 AI 生成代码或脚本的输入提示。

## 7. 功能落地说明
> 以下内容概述了当前代码库中对本需求的实现情况，便于 AI 或后续开发继续迭代。

### 7.1 后端
- **数据聚合**：`AdminServiceImpl` 增加 `getReportSummary()` 与 `getDeptReportDetail()`，通过 `bpm_application`、`bpm_leave_application`、`bpm_reimburse_application` 聚合出部门/岗位人数、月度申请总量与部门成员请假、报销明细。审批通过率按 `status=3` 计算，结果封装在 `ReportSummaryVo`、`ReportDeptDetailVo`。
- **API**：`AdminController` 暴露 `/admin/reports/summary` 与 `/admin/reports/dept-detail` GET 接口，`month` 默认当前月份，`deptId` 为部门明细必填。
- **扩展性**：同一服务层保留 `YearMonth` 解析、审批率计算等方法，便于后续接入定时任务生成快照。

### 7.2 前端
- **类型 & API**：在 `types/index.ts` 声明 `ReportSummary`、`ReportDeptDetail` 等报表结构，并在 `ReportDeptDetail` 中新增 `deptPostStats` 字段用于表示部门岗位分布；`adminApi` 保持 `getReportSummary`、`getDeptReportDetail` 两个方法，直接请求后端接口。
- **页面**：`ReportCenter` 页面（管理员导航“统计报表”）交互更新为：
  1. 顶部放置统一排版的月份选择输入与“刷新统计”按钮，放在同一张卡片内，辅助说明刷新逻辑。
  2. 选择月份后的首屏区域展示一张折线图，横轴为部门名称（类型），纵轴包含“申请总数”“申请通过数”两条折线，用于对比各部门表现。
  3. 折线图下方保留“卡片按钮”式部门报表列表，每张卡最左侧显示部门名称，右侧按“部门人数、请假申请数、报销申请数、总通过率”四个指标排版，点击即触发明细查询。
  4. 点击部门卡片后弹出模态框展示明细：上方显示该部门当月的岗位分布（人数），下方两张表分别列出成员请假次数/天数与报销次数/金额，支持加载态与错误提示。

### 7.3 尚未覆盖的部分
- 自动排程、折线图展示、报表导出功能在代码中尚未实现；当前仅提供实时查询与卡片式查看。若需自动化报表，请在后端加定时任务持久化统计结果，同时在前端添加图表组件。 
