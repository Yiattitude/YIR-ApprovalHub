# 部门审批指派机制说明

## 1. 背景与目标
为满足“普通员工提交审批时只能由本部门审批人处理”的流程要求，本次迭代实现了用户默认归属策略与部门审批人绑定能力。本说明面向开发、测试与运维团队，用于快速了解实现细节与验证重点。

## 2. 功能概览
1. **注册默认身份**：新注册用户固定为普通员工，`deptId` 与 `postId` 默认为空，在前端展示为“无”。
2. **提交流程校验**：
   - 未分配部门的用户无法发起请假/报销申请。
   - 申请提交时必须选择同部门且具备 `APPROVAL_REVIEW` 权限的审批人。
   - 系统阻止申请人选择自己或被禁用/未分配岗位的人员。
3. **审批人列表**：前端通过 `/application/approvers` 动态获取所属部门的审批人列表；若列表为空，提交按钮被禁用并提示联系管理员。
4. **任务指派**：后端在创建申请时，将待办任务直接指派给所选审批人，同时为审批节点命名为“<部门名>审批”。

## 3. 后端改动
| 模块 | 说明 |
| --- | --- |
| `LoginVo` | 新增 `deptId/deptName` 字段，便于前端展示用户归属。 |
| `AuthServiceImpl` | 注册用户时置空 `deptId/postId`；构建用户信息时查询部门名称。 |
| `CreateLeaveDto` / `CreateReimburseDto` | 新增必填字段 `approverId`。 |
| `ApplicationController` | 新增 `GET /application/approvers` 接口暴露审批人列表。 |
| `IApplicationService` / `ApplicationServiceImpl` | 
- 拒绝未分配部门的用户提交申请；
- 验证审批人（同部门、可用、具备 `APPROVAL_REVIEW` 权限、非本人）；
- 按照选择的审批人创建任务；
- `getMyApplications` 返回真实部门名称；
- 新增 `getDeptApprovers` 查询逻辑。 |

## 4. 前端改动
| 页面/模块 | 说明 |
| --- | --- |
| `types/index.ts` | `User` 补充 `deptId/deptName`，定义 `ApproverOption`，并在创建申请请求体中增加 `approverId`。 |
| `api/index.ts` | `applicationApi` 增加 `getApprovers` 方法并扩展提交请求。 |
| `CreateLeave` / `CreateReimburse` | 
- 读取登录用户的部门信息；
- 页面加载时调用 `getApprovers` 并缓存；
- 显示部门与审批人选择框；
- 当无部门或无审批人时禁用提交并提示原因；
- 将 `approverId` 一并提交。 |

## 5. 数据与配置要求
- 每个需要发起流程的部门至少需要一名具有审批权限（岗位权限包含 `APPROVAL_REVIEW`）的员工。
- 若组织结构调整，请同步更新岗位权限与部门分配，否则普通员工将无法提交申请。
- 初始 SQL 中的角色/权限数据仍可保留，但审批路径以岗位权限为准。建议为部门经理岗位配置 `APPROVAL_REVIEW` 权限。

## 6. 验证建议
1. **注册与登录**
   - 注册新账号后，登录响应应显示 `deptName=空`、`postName=空`，前端展示“无”。
   - 在未分配部门前，尝试进入创建申请页应看到“请先联系管理员为您分配部门”的提示且无法提交。
2. **部门审批人列表**
   - 为用户分配部门与拥有审批权限的岗位后，刷新表单应能看到审批人下拉；若所有审批人被禁用，列表应为空并提示。
3. **提交流程**
   - 成功提交请假/报销申请后，在待办任务表中需出现所选审批人记录，且任务节点名称带有部门信息。
   - 选择不同部门的审批人应被后端拒绝并返回明确错误。
4. **权限验证**
   - 取消审批人岗位权限或将其禁用，再次选择该审批人应收到“暂无审批权限/审批人无效”提示。

## 7. 后续优化方向
- 支持多级审批链（例如部门审批后流转到财务/人事）。
- 在管理员界面提供“部门可选审批人”视图，便于快速排查缺失配置。
- 结合通知服务，在审批人变更时及时提醒普通员工更新选择。

> 文档版本：2026-01-18。如对流程或接口进行调整，请同步更新本说明。