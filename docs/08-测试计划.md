# 审批系统 - 测试计划文档

## 1. 测试概述

### 1.1 测试目标
- 验证系统功能是否符合需求
- 确保系统稳定性和可靠性
- 发现并修复潜在缺陷
- 验证系统性能指标
- 确保系统安全性

### 1.2 测试范围

**包含**：
- ✅ 用户认证与授权
- ✅ 申请创建与管理
- ✅ 审批流程处理
- ✅ 文件上传下载
- ✅ 系统管理功能
- ✅ 统计报表（必做）

**不包含**：
- ❌ 第三方服务集成测试
- ❌ 浏览器兼容性测试（仅测试 Chrome）
- ❌ 移动端适配测试

### 1.3 测试环境

| 环境类型 | 配置 |
|---------|------|
| **开发环境** | 本地开发机 |
| **测试环境** | 独立测试服务器 |
| **预发布环境** | 生产级配置 |
| **生产环境** | 正式环境 |

## 2. 测试策略

### 2.1 测试层级

```
单元测试 (Unit Test)
    ↓
集成测试 (Integration Test)
    ↓
系统测试 (System Test)
    ↓
验收测试 (Acceptance Test)
```

### 2.2 测试类型

| 测试类型 | 说明 | 责任人 |
|---------|------|-------|
| **单元测试** | 测试单个函数/方法 | 开发人员 |
| **集成测试** | 测试模块间交互 | 开发人员 |
| **功能测试** | 验证业务功能 | 测试人员 |
| **性能测试** | 验证系统性能 | 测试人员 |
| **安全测试** | 验证系统安全性 | 安全工程师 |

## 3. 功能测试用例

### 3.1 用户认证模块

#### TC-AUTH-001：用户注册成功

| 项目 | 内容 |
|------|------|
| **前置条件** | 无 |
| **测试步骤** | 1. 打开注册页<br>2. 填写用户名、密码、确认密码、真实姓名、手机号、邮箱<br>3. 点击"注册"按钮 |
| **预期结果** | 注册成功，默认角色为"普通员工"，自动登录或跳转登录页 |
| **优先级** | P0 |

#### TC-AUTH-002：用户注册失败（用户名重复）

| 项目 | 内容 |
|------|------|
| **前置条件** | 已存在用户名为"zhangsan"的用户 |
| **测试步骤** | 1. 打开注册页<br>2. 填写用户名"zhangsan"<br>3. 填写其他信息<br>4. 点击"注册"按钮 |
| **预期结果** | 提示"用户名已存在" |
| **优先级** | P0 |

#### TC-AUTH-003：第三方登录（QQ）

| 项目 | 内容 |
|------|------|
| **前置条件** | 已配置 Auth.js 和 QQ 登录 |
| **测试步骤** | 1. 打开登录页<br>2. 点击"QQ登录"按钮<br>3. 在 QQ 授权页面同意授权 |
| **预期结果** | 登录成功，跳转到首页，如果是新用户则自动创建账号 |
| **优先级** | P1 |

#### TC-AUTH-004：用户登录成功

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户已注册 |
| **测试步骤** | 1. 打开登录页<br>2. 输入正确的用户名和密码<br>3. 点击"登录"按钮 |
| **预期结果** | 登录成功，跳转到首页 |
| **优先级** | P0 |

#### TC-AUTH-005：用户登录失败（密码错误）

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户已注册 |
| **测试步骤** | 1. 打开登录页<br>2. 输入正确的用户名和错误的密码<br>3. 点击"登录"按钮 |
| **预期结果** | 提示"用户名或密码错误" |
| **优先级** | P0 |

#### TC-AUTH-006：Token 过期自动跳转登录

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户已登录 |
| **测试步骤** | 1. 等待 Token 过期（或手动删除 Token）<br>2. 访问需要认证的页面 |
| **预期结果** | 自动跳转到登录页 |
| **优先级** | P1 |

### 3.2 申请管理模块

#### TC-APP-001：创建请假申请

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户已登录（普通员工） |
| **测试步骤** | 1. 进入"新建申请"页面<br>2. 选择"请假申请"<br>3. 填写请假类型、时间、天数、事由<br>4. 点击"提交" |
| **预期结果** | 创建成功，跳转到申请列表，状态为"待审批" |
| **优先级** | P0 |

#### TC-APP-002：创建报销申请

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户已登录（普通员工） |
| **测试步骤** | 1. 进入"新建申请"页面<br>2. 选择"报销申请"<br>3. 填写费用类型、金额、事由<br>4. 上传发票附件<br>5. 点击"提交" |
| **预期结果** | 创建成功，跳转到申请列表，状态为"待审批" |
| **优先级** | P0 |

#### TC-APP-003：查看申请详情

| 项目 | 内容 |
|------|------|
| **前置条件** | 已存在申请记录 |
| **测试步骤** | 1. 进入"我的申请"页面<br>2. 点击某个申请<br>3. 查看详情 |
| **预期结果** | 显示申请的完整信息和审批历史 |
| **优先级** | P0 |

#### TC-APP-004：撤回申请

| 项目 | 内容 |
|------|------|
| **前置条件** | 已提交申请，状态为"待审批" |
| **测试步骤** | 1. 进入"我的申请"页面<br>2. 点击"撤回"按钮<br>3. 确认撤回 |
| **预期结果** | 撤回成功，申请状态变为"已撤回" |
| **优先级** | P1 |

#### TC-APP-005：撤回申请失败（非待审批状态）

| 项目 | 内容 |
|------|------|
| **前置条件** | 已审批的申请 |
| **测试步骤** | 1. 尝试撤回已审批的申请 |
| **预期结果** | 提示"只能撤回待审批状态的申请" |
| **优先级** | P1 |

### 3.3 审批任务模块

#### TC-TASK-001：查看待办任务

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户已登录（审批人） |
| **测试步骤** | 1. 进入"待办任务"页面<br>2. 查看任务列表 |
| **预期结果** | 显示分配给当前用户的所有待审批任务 |
| **优先级** | P0 |

#### TC-TASK-002：同意审批

| 项目 | 内容 |
|------|------|
| **前置条件** | 存在待审批任务 |
| **测试步骤** | 1. 打开待审批任务<br>2. 选填审批意见<br>3. 点击"同意" |
| **预期结果** | 审批成功，任务状态更新，申请状态更新，申请人收到通知 |
| **优先级** | P0 |

#### TC-TASK-003：拒绝审批

| 项目 | 内容 |
|------|------|
| **前置条件** | 存在待审批任务 |
| **测试步骤** | 1. 打开待审批任务<br>2. 填写审批意见<br>3. 点击"拒绝" |
| **预期结果** | 审批成功，任务状态更新，申请状态变为"已拒绝"，申请人收到通知 |
| **优先级** | P0 |

#### TC-TASK-004：查看已办任务

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户已处理过审批任务 |
| **测试步骤** | 1. 进入"已办任务"页面<br>2. 查看任务列表 |
| **预期结果** | 显示用户已处理的所有审批任务及审批结果 |
| **优先级** | P1 |

### 3.4 文件管理模块

#### TC-FILE-001：上传文件

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户已登录 |
| **测试步骤** | 1. 在表单中选择文件上传<br>2. 选择合法文件（PDF）<br>3. 上传 |
| **预期结果** | 上传成功，返回文件地址 |
| **优先级** | P0 |

#### TC-FILE-002：上传文件失败（文件过大）

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户已登录 |
| **测试步骤** | 1. 选择超过 10MB 的文件<br>2. 尝试上传 |
| **预期结果** | 提示"文件大小超过限制" |
| **优先级** | P1 |

#### TC-FILE-003：下载文件

| 项目 | 内容 |
|------|------|
| **前置条件** | 已上传文件 |
| **测试步骤** | 1. 点击文件下载链接 |
| **预期结果** | 文件成功下载 |
| **优先级** | P1 |

### 3.5 系统管理模块

#### TC-SYS-001：创建用户

| 项目 | 内容 |
|------|------|
| **前置条件** | 管理员已登录 |
| **测试步骤** | 1. 进入用户管理页面<br>2. 点击"新建用户"<br>3. 填写用户信息<br>4. 分配角色<br>5. 保存 |
| **预期结果** | 用户创建成功，可以使用新账号登录 |
| **优先级** | P0 |

#### TC-SYS-002：创建部门

| 项目 | 内容 |
|------|------|
| **前置条件** | 管理员已登录 |
| **测试步骤** | 1. 进入部门管理页面<br>2. 点击"新建部门"<br>3. 填写部门信息<br>4. 保存 |
| **预期结果** | 部门创建成功，显示在部门树中 |
| **优先级** | P1 |

#### TC-SYS-003：分配角色

| 项目 | 内容 |
|------|------|
| **前置条件** | 已存在用户和角色 |
| **测试步骤** | 1. 编辑用户<br>2. 分配角色<br>3. 保存 |
| **预期结果** | 角色分配成功，用户获得对应权限 |
| **优先级** | P0 |

## 4. 性能测试

### 4.1 性能指标

| 指标 | 目标值 |
|------|-------|
| **响应时间** | < 2秒 |
| **并发用户数** | 100+ |
| **TPS** | 50+ |
| **错误率** | < 1% |

### 4.2 性能测试场景

#### PT-001：登录压力测试

**测试目标**：验证系统在高并发登录时的性能

**测试步骤**：
1. 使用 JMeter 配置 100 个并发用户
2. 持续登录 10 分钟
3. 记录响应时间、成功率、TPS

**预期结果**：
- 平均响应时间 < 2秒
- 成功率 > 99%
- TPS > 50

#### PT-002：创建申请压力测试

**测试目标**：验证高并发创建申请时的性能

**测试步骤**：
1. 使用 JMeter 配置 50 个并发用户
2. 持续创建申请 10 分钟
3. 记录响应时间、成功率、数据库性能

**预期结果**：
- 平均响应时间 < 3秒
- 成功率 > 99%
- 数据库 CPU < 80%

#### PT-003：查询列表压力测试

**测试目标**：验证列表查询性能

**测试步骤**：
1. 准备 10000 条申请数据
2. 使用 JMeter 配置 100 个并发用户
3. 持续查询申请列表 10 分钟

**预期结果**：
- 平均响应时间 < 1秒
- 成功率 > 99%

### 4.3 JMeter 测试脚本示例

**登录测试**：
```xml
<HTTPSamplerProxy>
  <stringProp name="HTTPSampler.domain">localhost</stringProp>
  <stringProp name="HTTPSampler.port">8080</stringProp>
  <stringProp name="HTTPSampler.path">/api/auth/login</stringProp>
  <stringProp name="HTTPSampler.method">POST</stringProp>
  <boolProp name="HTTPSampler.use_keepalive">true</boolProp>
  <elementProp name="HTTPsampler.Arguments">
    <collectionProp>
      <elementProp>
        <stringProp name="Argument.value">{"username":"admin","password":"123456"}</stringProp>
      </elementProp>
    </collectionProp>
  </elementProp>
</HTTPSamplerProxy>
```

## 5. 安全测试

### 5.1 安全测试用例

#### ST-001：SQL 注入测试

**测试步骤**：
1. 在登录表单中输入 `admin' OR '1'='1`
2. 提交登录请求

**预期结果**：登录失败，系统不受 SQL 注入影响

#### ST-002：XSS 攻击测试

**测试步骤**：
1. 在申请事由中输入 `<script>alert('XSS')</script>`
2. 提交申请
3. 查看申请详情

**预期结果**：脚本不执行，内容被转义显示

#### ST-003：CSRF 攻击测试

**测试步骤**：
1. 构造恶意请求
2. 在未登录状态下发送请求

**预期结果**：请求被拒绝，返回 401

#### ST-004：权限绕过测试

**测试步骤**：
1. 普通员工尝试访问管理员页面
2. 直接访问 `/system/user`

**预期结果**：访问被拒绝，返回 403

#### ST-005：文件上传漏洞测试

**测试步骤**：
1. 尝试上传恶意文件（如 .jsp、.exe）
2. 提交

**预期结果**：上传失败，提示文件类型不允许

## 6. 兼容性测试

### 6.1 浏览器兼容性

| 浏览器 | 版本 | 优先级 |
|-------|------|-------|
| Chrome | 120+ | P0 |
| Firefox | 120+ | P1 |
| Edge | 120+ | P1 |
| Safari | 17+ | P2 |

### 6.2 分辨率兼容性

| 分辨率 | 设备 | 优先级 |
|-------|------|-------|
| 1920x1080 | PC | P0 |
| 1366x768 | 笔记本 | P0 |
| 1280x720 | 小屏幕 | P1 |

## 7. 自动化测试

### 7.1 后端单元测试（JUnit）

```java
@SpringBootTest
class ApplicationServiceTest {

    @Autowired
    private IApplicationService applicationService;

    @Test
    void testCreateLeaveApplication() {
        LeaveApplicationDto dto = new LeaveApplicationDto();
        dto.setLeaveType(1);
        dto.setStartTime(LocalDateTime.now().plusDays(1));
        dto.setEndTime(LocalDateTime.now().plusDays(3));
        dto.setDays(3.0);
        dto.setReason("测试请假");
        
        Long appId = applicationService.createLeaveApplication(dto);
        assertNotNull(appId);
        assertTrue(appId > 0);
    }

    @Test
    void testWithdrawApplication() {
        // 创建申请
        Long appId = createTestApplication();
        
        // 撤回申请
        assertDoesNotThrow(() -> applicationService.withdrawApplication(appId));
        
        // 验证状态
        Application app = applicationService.getById(appId);
        assertEquals(5, app.getStatus()); // 已撤回
    }

    @Test
    void testWithdrawApplicationFailed() {
        // 创建已审批的申请
        Long appId = createApprovedApplication();
        
        // 尝试撤回
        assertThrows(BusinessException.class, () -> {
            applicationService.withdrawApplication(appId);
        });
    }
}
```

### 7.2 前端单元测试（Vitest）

```typescript
import { describe, it, expect } from 'vitest'
import { mount } from '@vue/test-utils'
import StatusTag from '@/components/StatusTag/index.vue'

describe('StatusTag', () => {
  it('renders correctly with status 1', () => {
    const wrapper = mount(StatusTag, {
      props: { status: 1 }
    })
    expect(wrapper.text()).toBe('待审批')
    expect(wrapper.find('.el-tag').classes()).toContain('el-tag--warning')
  })

  it('renders correctly with status 3', () => {
    const wrapper = mount(StatusTag, {
      props: { status: 3 }
    })
    expect(wrapper.text()).toBe('已通过')
    expect(wrapper.find('.el-tag').classes()).toContain('el-tag--success')
  })
})
```

### 7.3 E2E 测试（Playwright）

```typescript
import { test, expect } from '@playwright/test'

test('用户登录流程', async ({ page }) => {
  // 访问登录页
  await page.goto('http://localhost:3000/login')
  
  // 输入用户名和密码
  await page.fill('input[placeholder="用户名"]', 'admin')
  await page.fill('input[placeholder="密码"]', '123456')
  
  // 点击登录按钮
  await page.click('button:has-text("登录")')
  
  // 验证跳转到首页
  await expect(page).toHaveURL('http://localhost:3000/dashboard')
  await expect(page.locator('text=首页')).toBeVisible()
})

test('创建请假申请流程', async ({ page }) => {
  // 登录
  await login(page, 'zhangsan', '123456')
  
  // 进入新建申请页面
  await page.click('text=新建申请')
  await page.click('text=请假申请')
  
  // 填写表单
  await page.selectOption('select[name="leaveType"]', '1')
  await page.fill('input[name="days"]', '3')
  await page.fill('textarea[name="reason"]', '回家过年')
  
  // 提交
  await page.click('button:has-text("提交")')
  
  // 验证成功
  await expect(page.locator('text=提交成功')).toBeVisible()
})
```

## 8. 测试数据准备

### 8.1 测试用户数据

```sql
-- 系统管理员
INSERT INTO sys_user (username, password, real_name, dept_id, status) 
VALUES ('admin', '$2a$10$...', '管理员', 1, '1');

-- 部门经理（审批人）
INSERT INTO sys_user (username, password, real_name, dept_id, status) 
VALUES ('manager', '$2a$10$...', '张经理', 2, '1');

-- 普通员工
INSERT INTO sys_user (username, password, real_name, dept_id, status) 
VALUES ('employee', '$2a$10$...', '李员工', 2, '1');
```

### 8.2 测试部门数据

```sql
INSERT INTO sys_dept (dept_name, parent_id, leader) VALUES 
('总公司', 0, '张三'),
('技术部', 1, '李四'),
('财务部', 1, '王五');
```

### 8.3 测试申请数据

```sql
-- 创建测试申请（可用脚本批量生成）
INSERT INTO bpm_application (app_no, app_type, title, applicant_id, status) VALUES 
('AP20260115000001', 'leave', '请假申请-回家过年', 3, 1),
('AP20260115000002', 'reimburse', '报销申请-差旅费', 3, 2);
```

## 9. 缺陷管理

### 9.1 缺陷等级

| 等级 | 说明 | 修复时间 |
|------|------|---------|
| **P0** | 阻塞性缺陷，系统无法使用 | 立即修复 |
| **P1** | 严重缺陷，核心功能不可用 | 24小时内 |
| **P2** | 一般缺陷，功能部分不可用 | 3天内 |
| **P3** | 轻微缺陷，不影响使用 | 下个版本 |

### 9.2 缺陷报告模板

```markdown
**缺陷ID**：BUG-001
**标题**：登录失败后未清除密码输入框
**优先级**：P2
**严重程度**：中
**发现人**：测试人员
**发现时间**：2026-01-14
**所属模块**：用户认证

**复现步骤**：
1. 打开登录页
2. 输入错误的用户名和密码
3. 点击登录
4. 观察密码输入框

**预期结果**：密码输入框被清空
**实际结果**：密码仍然保留在输入框中

**截图/日志**：[附件]

**环境信息**：
- OS: Windows 11
- Browser: Chrome 120
- 后端版本: 1.0.0

**建议修复方案**：在登录失败后清空密码输入框
```

## 10. 测试报告模板

```markdown
# 审批系统测试报告

## 1. 测试概况
- **测试版本**：v1.0.0
- **测试周期**：2026-01-10 ~ 2026-01-15
- **测试人员**：张三、李四
- **测试环境**：测试服务器

## 2. 测试总结
- **测试用例总数**：150
- **执行用例数**：145
- **通过用例数**：140
- **失败用例数**：5
- **阻塞用例数**：0
- **通过率**：96.6%

## 3. 缺陷统计
| 等级 | 发现数量 | 已修复 | 待修复 |
|------|---------|-------|-------|
| P0 | 0 | 0 | 0 |
| P1 | 2 | 2 | 0 |
| P2 | 5 | 3 | 2 |
| P3 | 8 | 4 | 4 |
| **合计** | **15** | **9** | **6** |

## 4. 测试结论
系统核心功能基本正常，主要缺陷已修复，建议进入预发布环境测试。

待修复的 P2、P3 缺陷不影响核心流程，可在下个迭代修复。

## 5. 风险提示
- 性能测试中发现高并发时响应时间偶尔超过3秒，建议优化数据库查询
- 文件上传功能在网络不稳定时可能失败，建议增加重试机制

## 6. 建议
- 增加自动化测试覆盖率
- 完善监控告警机制
- 定期进行安全漏洞扫描
```

---

> 📅 **文档版本**：v1.0  
> 📝 **最后更新**：2026-01-14  
> 👤 **编写人**：测试工程师
