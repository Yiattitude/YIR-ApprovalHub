# 审批系统 - 数据库设计文档

## 1. 数据库选型

**数据库**：MySQL 8.0+  
**字符集**：utf8mb4  
**排序规则**：utf8mb4_general_ci  
**存储引擎**：InnoDB

## 2. 数据库设计原则

- ✅ 遵循第三范式（3NF），减少数据冗余
- ✅ 合理使用索引，提升查询性能
- ✅ 所有表必须有主键
- ✅ 所有表必须有创建时间、更新时间字段
- ✅ 使用逻辑删除，保留历史数据
- ✅ 外键约束通过应用层控制，不在数据库层设置

## 表目录

- [3.1 用户信息表 (sys_user)](#31-用户信息表-sys_user)
- [3.2 部门信息表 (sys_dept)](#32-部门信息表-sys_dept)
- [3.3 岗位信息表 (sys_post)](#33-岗位信息表-sys_post)
- [3.4 权限信息表 (sys_permission)](#34-权限信息表-sys_permission)
- [3.5 岗位权限关联表 (sys_post_permission)](#35-岗位权限关联表-sys_post_permission)
- [3.6 角色信息表 (sys_role)](#36-角色信息表-sys_role)
- [3.7 用户角色关联表 (sys_user_role)](#37-用户角色关联表-sys_user_role)
- [3.8 审批申请主表 (bpm_application)](#38-审批申请主表-bpm_application)
- [3.9 请假申请表 (bpm_leave_application)](#39-请假申请表-bpm_leave_application)
- [3.10 报销申请表 (bpm_reimburse_application)](#310-报销申请表-bpm_reimburse_application)
- [3.11 审批任务表 (bpm_task)](#311-审批任务表-bpm_task)
- [3.12 审批历史表 (bpm_history)](#312-审批历史表-bpm_history)
- [3.13 文件附件表 (sys_file)](#313-文件附件表-sys_file)
- [4.1 表单模板表 (bpm_form_template)](#41-表单模板表-bpm_form_template)
- [4.2 流程模板表 (bpm_process_template)](#42-流程模板表-bpm_process_template)

## 3. 表结构设计

### 3.1 用户信息表 (sys_user)

**表说明**：存储系统用户基本信息，用户与岗位通过 `post_id` 直接关联，岗位再决定权限。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| user_id | BIGINT | - | NO | - | 用户ID | PK |
| username | VARCHAR | 50 | NO | - | 登录账号（唯一） | UNI |
| password | VARCHAR | 200 | NO | - | 登录密码（BCrypt） | - |
| real_name | VARCHAR | 50 | NO | - | 真实姓名 | - |
| phone | VARCHAR | 20 | YES | NULL | 手机号 | - |
| email | VARCHAR | 100 | YES | NULL | 邮箱 | - |
| dept_id | BIGINT | YES | NULL | 所属部门ID | IDX |
| post_id | BIGINT | YES | NULL | 岗位ID（决定权限） | - |
| avatar | VARCHAR | 255 | YES | NULL | 头像地址 | - |
| status | TINYINT | - | NO | 1 | 状态（0禁用 1启用） | - |
| del_flag | TINYINT | - | NO | 0 | 删除标志（0存在 1删除） | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 | - |
| update_time | DATETIME | - | YES | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | - |

```sql
CREATE TABLE `sys_user` (
  `user_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(200) NOT NULL COMMENT '密码',
  `real_name` VARCHAR(50) NOT NULL COMMENT '真实姓名',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `dept_id` BIGINT DEFAULT NULL COMMENT '部门ID',
  `post_id` BIGINT DEFAULT NULL COMMENT '岗位ID',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像地址',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0=禁用 1=启用',
  `del_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0=正常 1=删除',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`user_id`),
  UNIQUE KEY `idx_username` (`username`),
  KEY `idx_dept_id` (`dept_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户信息表';
```

### 3.2 部门信息表 (sys_dept)

**表说明**：存储企业组织架构信息，支持多级部门树。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| dept_id | BIGINT | - | NO | - | 部门ID | PK |
| parent_id | BIGINT | - | NO | 0 | 父部门ID（0为顶级） | IDX |
| dept_name | VARCHAR | 50 | NO | - | 部门名称 | - |
| leader | VARCHAR | 50 | YES | NULL | 部门负责人 | - |
| phone | VARCHAR | 20 | YES | NULL | 联系电话 | - |
| email | VARCHAR | 100 | YES | NULL | 邮箱 | - |
| order_num | INT | - | YES | 0 | 显示顺序 | - |
| status | TINYINT | - | NO | 1 | 状态（0禁用 1启用） | - |
| del_flag | TINYINT | - | NO | 0 | 删除标志 | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 | - |
| update_time | DATETIME | - | YES | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | - |

```sql
CREATE TABLE `sys_dept` (
  `dept_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '部门ID',
  `parent_id` BIGINT NOT NULL DEFAULT 0 COMMENT '父部门ID',
  `dept_name` VARCHAR(50) NOT NULL COMMENT '部门名称',
  `leader` VARCHAR(50) DEFAULT NULL COMMENT '负责人',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '联系电话',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `order_num` INT DEFAULT 0 COMMENT '显示顺序',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0=禁用 1=启用',
  `del_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0=正常 1=删除',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`dept_id`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='部门信息表';
```

### 3.3 岗位信息表 (sys_post)

**表说明**：岗位与权限绑定，用户继承岗位权限。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| post_id | BIGINT | - | NO | - | 岗位ID | PK |
| post_code | VARCHAR | 50 | NO | - | 岗位编码（唯一） | UNI |
| post_name | VARCHAR | 50 | NO | - | 岗位名称 | - |
| post_sort | INT | - | YES | 0 | 显示顺序 | - |
| status | TINYINT | - | NO | 1 | 状态（0禁用 1启用） | - |
| del_flag | TINYINT | - | NO | 0 | 删除标志 | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 | - |
| update_time | DATETIME | - | YES | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | - |

```sql
CREATE TABLE `sys_post` (
  `post_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '岗位ID',
  `post_code` VARCHAR(50) NOT NULL COMMENT '岗位编码',
  `post_name` VARCHAR(50) NOT NULL COMMENT '岗位名称',
  `post_sort` INT DEFAULT 0 COMMENT '显示顺序',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0=禁用 1=启用',
  `del_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0=正常 1=删除',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`post_id`),
  UNIQUE KEY `uk_post_code` (`post_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='岗位信息表';
```

### 3.4 权限信息表 (sys_permission)

**表说明**：用于维护系统可配置的权限标识，岗位与权限绑定。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| permission_id | BIGINT | - | NO | - | 权限ID | PK |
| permission_code | VARCHAR | 100 | NO | - | 权限编码（唯一） | UNI |
| permission_name | VARCHAR | 100 | NO | - | 权限名称 | - |
| description | VARCHAR | 255 | YES | NULL | 权限描述 | - |
| status | TINYINT | - | NO | 1 | 状态（0禁用 1启用） | - |
| del_flag | TINYINT | - | NO | 0 | 删除标志 | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 | - |
| update_time | DATETIME | - | YES | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | - |

```sql
CREATE TABLE `sys_permission` (
  `permission_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '权限ID',
  `permission_code` VARCHAR(100) NOT NULL COMMENT '权限编码',
  `permission_name` VARCHAR(100) NOT NULL COMMENT '权限名称',
  `description` VARCHAR(255) DEFAULT NULL COMMENT '权限描述',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0=禁用 1=启用',
  `del_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0=正常 1=删除',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`permission_id`),
  UNIQUE KEY `uk_permission_code` (`permission_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='权限表';
```

### 3.5 岗位权限关联表 (sys_post_permission)

**表说明**：定义岗位可以拥有的权限，支持一对多配置。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| post_id | BIGINT | - | NO | - | 岗位ID | PK |
| permission_id | BIGINT | - | NO | - | 权限ID | PK |

```sql
CREATE TABLE `sys_post_permission` (
  `post_id` BIGINT NOT NULL COMMENT '岗位ID',
  `permission_id` BIGINT NOT NULL COMMENT '权限ID',
  PRIMARY KEY (`post_id`, `permission_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='岗位权限关联表';
```

### 3.6 角色信息表 (sys_role)

**表说明**：保留角色概念以兼容历史需求，主要用于基础分权或统计。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| role_id | BIGINT | - | NO | - | 角色ID | PK |
| role_name | VARCHAR | 50 | NO | - | 角色名称 | - |
| role_key | VARCHAR | 50 | NO | - | 角色标识（唯一） | UNI |
| role_sort | INT | - | YES | 0 | 显示顺序 | - |
| status | TINYINT | - | NO | 1 | 状态（0禁用 1启用） | - |
| del_flag | TINYINT | - | NO | 0 | 删除标志 | - |
| remark | VARCHAR | 500 | YES | NULL | 备注 | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 | - |
| update_time | DATETIME | - | YES | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | - |

```sql
CREATE TABLE `sys_role` (
  `role_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '角色ID',
  `role_name` VARCHAR(50) NOT NULL COMMENT '角色名称',
  `role_key` VARCHAR(50) NOT NULL COMMENT '角色标识',
  `role_sort` INT DEFAULT 0 COMMENT '显示顺序',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0=禁用 1=启用',
  `del_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0=正常 1=删除',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`role_id`),
  UNIQUE KEY `uk_role_key` (`role_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色信息表';
```

### 3.7 用户角色关联表 (sys_user_role)

**表说明**：用户与角色的多对多关系

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| user_id | BIGINT | - | NO | - | 用户ID | PK |
| role_id | BIGINT | - | NO | - | 角色ID | PK |

```sql
CREATE TABLE `sys_user_role` (
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `role_id` BIGINT NOT NULL COMMENT '角色ID',
  PRIMARY KEY (`user_id`, `role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

### 3.8 审批申请主表 (bpm_application)

**表说明**：存储所有审批申请的主数据，关联数据拆分在业务子表。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| app_id | BIGINT | - | NO | - | 申请ID | PK |
| app_no | VARCHAR | 50 | NO | - | 申请单号（唯一） | UNI |
| app_type | VARCHAR | 20 | NO | - | 申请类型（leave/reimburse） | IDX |
| title | VARCHAR | 200 | NO | - | 申请标题 | - |
| applicant_id | BIGINT | - | NO | - | 申请人ID | IDX |
| dept_id | BIGINT | - | YES | NULL | 申请人部门ID | IDX |
| status | TINYINT | - | NO | 1 | 状态（0草稿 1待审批 2审批中 3已通过 4已拒绝 5已撤回） | IDX |
| current_node | VARCHAR | 100 | YES | NULL | 当前审批节点 | - |
| submit_time | DATETIME | - | YES | NULL | 提交时间 | IDX |
| finish_time | DATETIME | - | YES | NULL | 完成时间 | - |
| del_flag | TINYINT | - | NO | 0 | 删除标志 | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 | - |
| update_time | DATETIME | - | YES | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | - |

```sql
CREATE TABLE `bpm_application` (
  `app_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '申请ID',
  `app_no` VARCHAR(50) NOT NULL COMMENT '申请单号',
  `app_type` VARCHAR(20) NOT NULL COMMENT '申请类型',
  `title` VARCHAR(200) NOT NULL COMMENT '申请标题',
  `applicant_id` BIGINT NOT NULL COMMENT '申请人ID',
  `dept_id` BIGINT DEFAULT NULL COMMENT '部门ID',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0=草稿 1=待审批 2=审批中 3=已通过 4=已拒绝 5=已撤回',
  `current_node` VARCHAR(100) DEFAULT NULL COMMENT '当前审批节点',
  `submit_time` DATETIME DEFAULT NULL COMMENT '提交时间',
  `finish_time` DATETIME DEFAULT NULL COMMENT '完成时间',
  `del_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0=正常 1=删除',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`app_id`),
  UNIQUE KEY `uk_app_no` (`app_no`),
  KEY `idx_applicant_id` (`applicant_id`),
  KEY `idx_app_type` (`app_type`),
  KEY `idx_dept_id` (`dept_id`),
  KEY `idx_status` (`status`),
  KEY `idx_submit_time` (`submit_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审批申请主表';
```

### 3.9 请假申请表 (bpm_leave_application)

**表说明**：存储请假申请的详细信息

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| leave_id | BIGINT | - | NO | - | 请假ID | PK |
| app_id | BIGINT | - | NO | - | 申请ID（关联主表） | UNI |
| leave_type | TINYINT | - | NO | - | 请假类型（1事假 2病假 3年假 4调休） | - |
| start_time | DATETIME | - | NO | - | 开始时间 | - |
| end_time | DATETIME | - | NO | - | 结束时间 | - |
| days | DECIMAL | 10,2 | NO | - | 请假天数 | - |
| reason | VARCHAR | 500 | NO | - | 请假事由 | - |
| attachment | VARCHAR | 500 | YES | NULL | 附件地址（多个用逗号分隔） | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 | - |
| update_time | DATETIME | - | YES | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | - |

```sql
CREATE TABLE `bpm_leave_application` (
  `leave_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '请假ID',
  `app_id` BIGINT NOT NULL COMMENT '申请ID',
  `leave_type` TINYINT NOT NULL COMMENT '请假类型',
  `start_time` DATETIME NOT NULL COMMENT '开始时间',
  `end_time` DATETIME NOT NULL COMMENT '结束时间',
  `days` DECIMAL(10,2) NOT NULL COMMENT '请假天数',
  `reason` VARCHAR(500) NOT NULL COMMENT '请假事由',
  `attachment` VARCHAR(500) DEFAULT NULL COMMENT '附件地址',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`leave_id`),
  UNIQUE KEY `uk_app_id` (`app_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='请假申请表';
```

### 3.10 报销申请表 (bpm_reimburse_application)

**表说明**：存储报销申请的详细信息

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| reimburse_id | BIGINT | - | NO | - | 报销ID | PK |
| app_id | BIGINT | - | NO | - | 申请ID（关联主表） | UNI |
| expense_type | TINYINT | - | NO | - | 费用类型（1差旅费 2餐饮费 3办公费 4其他） | - |
| amount | DECIMAL | 10,2 | NO | - | 报销金额 | - |
| reason | VARCHAR | 500 | NO | - | 报销事由 | - |
| invoice_attachment | VARCHAR | 500 | NO | - | 发票附件（必填） | - |
| occur_date | DATE | - | NO | - | 发生日期 | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 | - |
| update_time | DATETIME | - | YES | CURRENT_TIMESTAMP ON UPDATE | 更新时间 | - |

```sql
CREATE TABLE `bpm_reimburse_application` (
  `reimburse_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '报销ID',
  `app_id` BIGINT NOT NULL COMMENT '申请ID',
  `expense_type` TINYINT NOT NULL COMMENT '费用类型',
  `amount` DECIMAL(10,2) NOT NULL COMMENT '报销金额',
  `reason` VARCHAR(500) NOT NULL COMMENT '报销事由',
  `invoice_attachment` VARCHAR(500) NOT NULL COMMENT '发票附件',
  `occur_date` DATE NOT NULL COMMENT '发生日期',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`reimburse_id`),
  UNIQUE KEY `uk_app_id` (`app_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='报销申请表';
```

### 3.11 审批任务表 (bpm_task)

**表说明**：存储当前待办/已办任务记录，审批动作归档至 `bpm_history`。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| task_id | BIGINT | - | NO | - | 任务ID | PK |
| app_id | BIGINT | - | NO | - | 申请ID | IDX |
| node_name | VARCHAR | 100 | NO | - | 节点名称 | - |
| assignee_id | BIGINT | - | NO | - | 审批人ID | IDX |
| assignee_name | VARCHAR | 50 | YES | NULL | 审批人姓名 | - |
| status | TINYINT | - | NO | 0 | 任务状态（0待处理 1已处理） | IDX |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 | - |
| finish_time | DATETIME | - | YES | NULL | 完成时间 | - |

```sql
CREATE TABLE `bpm_task` (
  `task_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '任务ID',
  `app_id` BIGINT NOT NULL COMMENT '申请ID',
  `node_name` VARCHAR(100) NOT NULL COMMENT '节点名称',
  `assignee_id` BIGINT NOT NULL COMMENT '审批人ID',
  `assignee_name` VARCHAR(50) DEFAULT NULL COMMENT '审批人姓名',
  `status` TINYINT DEFAULT 0 COMMENT '状态：0=待处理 1=已处理',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `finish_time` DATETIME DEFAULT NULL COMMENT '完成时间',
  PRIMARY KEY (`task_id`),
  KEY `idx_app_id` (`app_id`),
  KEY `idx_assignee_id` (`assignee_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审批任务表';
```

### 3.12 审批历史表 (bpm_history)

**表说明**：记录流程中每一次审批动作，供审计与追溯使用。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| history_id | BIGINT | - | NO | - | 历史ID | PK |
| app_id | BIGINT | - | NO | - | 申请ID | IDX |
| task_id | BIGINT | - | YES | NULL | 对应任务ID | IDX |
| node_name | VARCHAR | 100 | NO | - | 节点名称 | - |
| approver_id | BIGINT | - | YES | NULL | 审批人ID | - |
| approver_name | VARCHAR | 50 | YES | NULL | 审批人姓名 | - |
| action | TINYINT | - | YES | NULL | 审批动作（1同意 2拒绝） | - |
| comment | VARCHAR | 500 | YES | NULL | 审批意见 | - |
| approve_time | DATETIME | - | YES | NULL | 审批时间 | - |
| next_node | VARCHAR | 100 | YES | NULL | 下一节点 | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 记录时间 | - |

```sql
CREATE TABLE `bpm_history` (
  `history_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '历史ID',
  `app_id` BIGINT NOT NULL COMMENT '申请ID',
  `task_id` BIGINT DEFAULT NULL COMMENT '任务ID',
  `node_name` VARCHAR(100) NOT NULL COMMENT '节点名称',
  `approver_id` BIGINT DEFAULT NULL COMMENT '审批人ID',
  `approver_name` VARCHAR(50) DEFAULT NULL COMMENT '审批人姓名',
  `action` TINYINT DEFAULT NULL COMMENT '审批动作：1=同意 2=拒绝',
  `comment` VARCHAR(500) DEFAULT NULL COMMENT '审批意见',
  `approve_time` DATETIME DEFAULT NULL COMMENT '审批时间',
  `next_node` VARCHAR(100) DEFAULT NULL COMMENT '下一节点',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`history_id`),
  KEY `idx_app_id` (`app_id`),
  KEY `idx_task_id` (`task_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审批历史表';
```

### 3.13 文件附件表 (sys_file)

**表说明**：统一存储上传的文件信息，支持按业务类型与业务ID索引。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 | 索引 |
|-------|------|-----|-------|-------|------|-----|
| file_id | BIGINT | - | NO | - | 文件ID | PK |
| file_name | VARCHAR | 255 | NO | - | 原始文件名 | - |
| file_path | VARCHAR | 500 | NO | - | 存储路径 | - |
| file_size | BIGINT | - | YES | NULL | 文件大小（字节） | - |
| file_type | VARCHAR | 50 | YES | NULL | MIME 类型 | - |
| business_type | VARCHAR | 50 | YES | NULL | 业务类型（leave/reimburse等） | IDX |
| business_id | BIGINT | - | YES | NULL | 业务ID | IDX |
| uploader_id | BIGINT | - | YES | NULL | 上传人ID | - |
| del_flag | TINYINT | - | NO | 0 | 删除标志 | - |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 上传时间 | - |

```sql
CREATE TABLE `sys_file` (
  `file_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '文件ID',
  `file_name` VARCHAR(255) NOT NULL COMMENT '文件名',
  `file_path` VARCHAR(500) NOT NULL COMMENT '文件路径',
  `file_size` BIGINT DEFAULT NULL COMMENT '文件大小',
  `file_type` VARCHAR(50) DEFAULT NULL COMMENT '文件类型',
  `business_type` VARCHAR(50) DEFAULT NULL COMMENT '业务类型',
  `business_id` BIGINT DEFAULT NULL COMMENT '业务ID',
  `uploader_id` BIGINT DEFAULT NULL COMMENT '上传人ID',
  `del_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0=正常 1=删除',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`file_id`),
  KEY `idx_business` (`business_type`, `business_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件附件表';
```

## 4. 数据字典表（选做功能）

### 4.1 表单模板表 (bpm_form_template)

```sql
CREATE TABLE `bpm_form_template` (
  `template_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '模板ID',
  `template_name` VARCHAR(100) NOT NULL COMMENT '模板名称',
  `template_key` VARCHAR(50) NOT NULL COMMENT '模板标识',
  `form_config` TEXT COMMENT '表单配置（JSON）',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0=禁用 1=启用',
  `del_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0=正常 1=删除',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`template_id`),
  UNIQUE KEY `uk_template_key` (`template_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='表单模板表';
```

### 4.2 流程模板表 (bpm_process_template)

```sql
CREATE TABLE `bpm_process_template` (
  `template_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '模板ID',
  `template_name` VARCHAR(100) NOT NULL COMMENT '模板名称',
  `template_key` VARCHAR(50) NOT NULL COMMENT '模板标识',
  `process_config` TEXT COMMENT '流程配置（JSON/BPMN）',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0=禁用 1=启用',
  `del_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0=正常 1=删除',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`template_id`),
  UNIQUE KEY `uk_process_key` (`template_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程模板表';
```

## 5. 初始化数据（SQL脚本）

以下片段与 `sql/02-init-data.sql` 保持一致，可用于一次性灌入演示数据。

### 5.1 初始化角色数据

```sql
INSERT INTO sys_role (role_id, role_name, role_key, role_sort, remark) VALUES
(1, '系统管理员', 'ROLE_ADMIN', 1, '拥有系统最高权限'),
(2, '审批人', 'ROLE_APPROVER', 2, '可以审批申请'),
(3, '普通员工', 'ROLE_USER', 3, '可以发起申请');
```

### 5.2 初始化权限数据

```sql
INSERT INTO sys_permission (permission_id, permission_code, permission_name, description) VALUES
(1, 'SYSTEM_ADMIN', '系统管理权限', '可访问系统管理后台'),
(2, 'APPROVAL_REVIEW', '审批处理权限', '可处理审批任务'),
(3, 'APPLICATION_SUBMIT', '申请提交权限', '可发起业务申请');
```

### 5.3 初始化部门数据

```sql
INSERT INTO sys_dept (dept_id, parent_id, dept_name, leader, order_num) VALUES
(1, 0, '总公司', '张总', 1),
(2, 1, '技术部', '李经理', 1),
(3, 1, '财务部', '王经理', 2),
(4, 1, '人事部', '赵经理', 3),
(5, 2, '前端组', '前端组长', 1),
(6, 2, '后端组', '后端组长', 2);
```

### 5.4 初始化岗位与岗位权限

```sql
INSERT INTO sys_post (post_id, post_code, post_name, post_sort) VALUES
(1, 'CEO', '总经理', 1),
(2, 'MANAGER', '部门经理', 2),
(3, 'LEADER', '组长', 3),
(4, 'EMPLOYEE', '普通员工', 4);

INSERT INTO sys_post_permission (post_id, permission_id) VALUES
(1, 1), (1, 2), (1, 3),
(2, 2), (2, 3),
(3, 2), (3, 3),
(4, 3);
```

### 5.5 初始化用户数据

```sql
-- 密码明文：123456，对应 BCrypt：$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi
INSERT INTO sys_user (user_id, username, password, real_name, phone, email, dept_id, post_id, status) VALUES
(1, 'admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '系统管理员', '13800138000', 'admin@approval.com', 1, 1, 1),
(2, 'tech_manager', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '李经理', '13800138001', 'tech@approval.com', 2, 2, 1),
(3, 'finance_manager', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '王经理', '13800138002', 'finance@approval.com', 3, 2, 1),
(4, 'hr_manager', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '赵经理', '13800138003', 'hr@approval.com', 4, 2, 1),
(5, 'zhangsan', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '张三', '13800138005', 'zhangsan@approval.com', 5, 4, 1),
(6, 'lisi', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '李四', '13800138006', 'lisi@approval.com', 6, 4, 1),
(7, 'wangwu', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '王五', '13800138007', 'wangwu@approval.com', 2, 4, 1);
```

### 5.6 初始化用户角色关联

```sql
INSERT INTO sys_user_role (user_id, role_id) VALUES
(1, 1), (1, 2), (1, 3),
(2, 2), (2, 3),
(3, 2), (3, 3),
(4, 2), (4, 3),
(5, 3), (6, 3), (7, 3);
```

### 5.7 初始化测试审批数据

```sql
INSERT INTO bpm_application (app_id, app_no, app_type, title, applicant_id, dept_id, status, submit_time) VALUES
(1, 'AP20260114000001', 'leave', '请假申请-春节回家', 5, 5, 3, '2026-01-10 10:00:00'),
(2, 'AP20260114000002', 'reimburse', '报销申请-出差费用', 6, 6, 1, '2026-01-12 14:30:00'),
(3, 'AP20260114000003', 'leave', '请假申请-病假', 7, 2, 2, '2026-01-13 09:15:00');

INSERT INTO bpm_leave_application (app_id, leave_type, start_time, end_time, days, reason) VALUES
(1, 1, '2026-01-20 09:00:00', '2026-01-25 18:00:00', 5.0, '春节回家过年'),
(3, 2, '2026-01-15 09:00:00', '2026-01-16 18:00:00', 2.0, '感冒发烧，需要休息');

INSERT INTO bpm_reimburse_application (app_id, expense_type, amount, reason, invoice_attachment, occur_date) VALUES
(2, 1, 1580.50, '北京出差费用报销', '/upload/invoice_001.pdf', '2026-01-10');

INSERT INTO bpm_history (app_id, node_name, approver_id, approver_name, action, comment, approve_time, next_node) VALUES
(1, '提交申请', 5, '张三', NULL, '发起申请', '2026-01-10 10:00:00', '部门经理审批'),
(1, '部门经理审批', 2, '李经理', 1, '同意请假，注意安全', '2026-01-10 15:30:00', '结束'),
(3, '提交申请', 7, '王五', NULL, '发起申请', '2026-01-13 09:15:00', '部门经理审批');

INSERT INTO bpm_task (app_id, node_name, assignee_id, assignee_name, status) VALUES
(2, '部门经理审批', 2, '李经理', 0),
(3, '部门经理审批', 2, '李经理', 0);
```

## 6. ER 图（实体关系图）

```
        [sys_post] N----N [sys_permission]
          |             ^
          |             |
[sys_user] N----1 [sys_dept]      |
  |               ^             |
  |               |             |
  +----1 (post_id)+             |
                                   
[sys_user] 1----N [bpm_application]
  |                     |
  |                     +----1 [bpm_leave_application]
  |                     |
  |                     +----1 [bpm_reimburse_application]

[bpm_application] 1----N [bpm_task]
[bpm_task] 1----N [bpm_history]
[bpm_application] 1----N [sys_file]
```

## 7. 索引设计建议

### 7.1 常用查询场景

1. **查询我的申请列表**
   ```sql
   SELECT * FROM bpm_application 
   WHERE applicant_id = ? 
   ORDER BY create_time DESC;
   ```
   - 索引：`idx_applicant_id`

2. **查询待办任务**
  ```sql
  SELECT * FROM bpm_task 
  WHERE assignee_id = ? AND status = 0
  ORDER BY create_time DESC;
  ```
  - 索引：`idx_assignee_id`、`idx_status`

3. **根据申请单号查询**
   ```sql
   SELECT * FROM bpm_application WHERE app_no = ?;
   ```
   - 索引：`uk_app_no`（唯一索引）

### 7.2 复合索引建议

```sql
-- 待办任务查询优化
CREATE INDEX idx_task_status_assignee ON bpm_task(status, assignee_id, create_time);

-- 申请列表查询优化
CREATE INDEX idx_applicant_status_time ON bpm_application(applicant_id, status, submit_time);
```

---

> 📅 **文档版本**：v1.1  
> 📝 **最后更新**：2026-01-20  
> 👤 **编写人**：数据库设计师
