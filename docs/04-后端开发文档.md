# 审批系统 - 后端开发文档

## 1. 技术栈

- **Spring Boot 3.2.x**：承载 HTTP 服务、自动配置、依赖管理。
- **Spring Security + JWT**：完成身份认证、接口鉴权与 Token 生命周期管理。
- **MyBatis Plus**：对接关系型数据库，提供条件构造器、通用 CRUD、逻辑删除等能力。
- **MySQL 8.0**：核心业务库；Redis 可按需启用缓存与分布式锁。
- **Knife4j、Lombok、Hutool**：分别用于在线文档、样板代码消除与常用工具封装。
- **Maven + VS Code**：构建与开发环境；JDK17 是默认运行时。

## 2. 项目结构与文件说明

### 2.1 顶层目录

```
approval-backend/
├── pom.xml
├── src/main/java/com/approval/...
├── src/main/resources/
├── target/                       # 编译输出，部署时生成
└── upload/                       # 运行期上传文件占位
```

### 2.2 Java 源码目录 (com.approval)

| 路径 | 说明 | 责任 |
| --- | --- | --- |
| ApprovalApplication.java | Spring Boot 入口，触发组件扫描与自动配置 | 启动与健康探测入口 |
| common/exception/BusinessException.java | 业务异常基类，封装错误码/提示 | Service 层主动抛出受控异常 |
| common/exception/GlobalExceptionHandler.java | `@RestControllerAdvice` 统一兜底 | 转换异常为标准响应 |
| common/result/Result.java | 通用响应包装器 | 统一接口返回格式 |
| common/result/ResultCode.java | 响应码枚举 | 规范化状态码和文案 |
| common/utils/JwtUtils.java | JWT 颁发、解析、校验工具 | Token 生成与验签 |
| config/FileStorageProperties.java | `@ConfigurationProperties`，描述上传路径/大小限制 | 文件模块共享存储策略 |
| config/JwtAuthenticationTokenFilter.java | 读取 Header 中的 Token，构造认证上下文 | 无状态登录核心过滤器 |
| config/MyBatisPlusConfig.java | MyBatis Plus 插件（分页、乐观锁、逻辑删）及实体扫描 | 统一数据访问行为 |
| config/SecurityConfig.java | Spring Security 主配置 | HTTP 安全、授权规则、过滤链 |
| config/WebMvcConfig.java | CORS、消息转换器、拦截器挂载 | 统一 Web 层行为 |

### 2.3 业务模块 —— module.auth

| 文件 | 说明 |
| --- | --- |
| controller/AuthController.java | 暴露 `/auth/login`、`/auth/register` 等认证接口，并调用 AuthService 完成登录流程。 |
| dto/LoginDto.java | 登录表单载体，包含账号、密码、验证码等字段的校验注解。 |
| dto/RegisterDto.java | 注册信息载体，封装基础资料、部门/岗位选择。 |
| service/IAuthService.java | 认证服务接口，定义登录、注册、刷新 Token 的契约。 |
| service/impl/AuthServiceImpl.java | 结合 `UserMapper`、`JwtUtils`、`PasswordEncoder` 实现 IAuthService。 |
| vo/LoginVo.java | 登录成功返回给前端的视图对象（Token、过期时间、角色列表等）。 |

### 2.4 业务模块 —— module.system

| 文件 | 说明 |
| --- | --- |
| controller/AdminController.java | 管理员工作台聚合接口，提供仪表盘与批量操作。 |
| controller/FileController.java | 统一的文件上传/下载入口，兼容本地与对象存储。 |
| controller/TestController.java | 内部联调用健康接口。 |
| dto/AssignPostDto.java | 分派岗位的请求对象，包含岗位 ID、审批权限等。 |
| dto/AssignRolesDto.java | 分派角色，驱动 `sys_user_role` 维护。 |
| dto/DeptDto.java | 部门新增/更新载体，包含负责人、排序、状态。 |
| dto/PostDto.java | 岗位配置载体，覆盖岗位名称、审批阈值。 |
| dto/UserDto.java | 用户管理表单，含基础信息和岗位绑定。 |
| entity/Dept.java | 对应 `sys_dept`，保存组织树结构。 |
| entity/Permission.java | 对应 `sys_permission`，描述功能点编码。 |
| entity/Post.java | 对应 `sys_post`，承载岗位与审批粒度。 |
| entity/Role.java | 传统角色模型，用于平台级权限控制。 |
| entity/User.java | 平台用户实体，包含岗位、部门、登录属性。 |
| mapper/DeptMapper.java 等 | MyBatis Plus Mapper，负责各实体的 CRUD 映射。 |
| service/IAdminService.java | 系统管理聚合服务接口。 |
| service/impl/AdminServiceImpl.java | 组合多 Mapper 完成部门、岗位、权限的增删改查。 |
| vo/DeptVo.java | 部门树形视图。 |
| vo/PermissionVo.java | 权限点与按钮视图。 |
| vo/PostVo.java | 岗位详情视图。 |
| vo/UserVo.java | 用户详情视图，拼装部门/岗位/角色信息。 |
| vo/report/ReportDeptDetailVo.java | 管理员统计报表的部门维度视图。 |
| vo/report/ReportSummaryVo.java | 汇总指标视图，供报表折线/饼图使用。 |

### 2.5 业务模块 —— module.approval

| 文件 | 说明 |
| --- | --- |
| controller/AdminApplicationController.java | 管理端查询所有申请、批量导出。 |
| controller/ApplicationController.java | 员工提交/撤回申请、查询我的申请。 |
| controller/TaskController.java | 审批人待办/已办、审批动作提交接口。 |
| dto/ApproveTaskDto.java | 审批动作载体，含任务 ID、意见、附件。 |
| dto/CreateLeaveDto.java | 创建请假申请所需字段（类型、时间、原因）。 |
| dto/CreateReimburseDto.java | 报销申请信息。 |
| entity/Application.java | 主申请单，关联 BPM 基础信息。 |
| entity/History.java | 审批轨迹记录，用于追溯。 |
| entity/LeaveApplication.java | 请假补充字段，如天数、班次。 |
| entity/ReimburseApplication.java | 报销补充字段，如金额、发票号。 |
| entity/Task.java | 审批任务实体，对应 `bpm_task`。 |
| mapper/ApplicationMapper.java 等 | Mapper 层负责多表查询与统计。 |
| service/IApplicationService.java | 申请生命周期接口。 |
| service/ITaskService.java | 任务派发、执行、转办接口。 |
| service/impl/ApplicationServiceImpl.java | 实现申请创建、撤回、统计等逻辑。 |
| service/impl/TaskServiceImpl.java | 实现任务签收、审批、委派。 |
| vo/ApplicationHistoryVo.java | 以时间线形式返回历史。 |
| vo/ApplicationSummaryVo.java | 管理端汇总视图。 |
| vo/ApplicationVo.java | 申请详情视图。 |
| vo/ApprovalTypeStatVo.java | 各申请类型统计。 |
| vo/ApproverDashboardVo.java | 审批人仪表盘核心指标。 |
| vo/ApproverOptionVo.java | 前端审批人下拉数据。 |
| vo/DailyApprovalStatVo.java | 日度审批趋势。 |
| vo/MonthlyApprovalStatVo.java | 月度审批趋势。 |
| vo/TaskVo.java | 待办/已办任务展示体。 |

### 2.6 资源文件

| 文件 | 说明 |
| --- | --- |
| src/main/resources/application.yml | 激活的统一配置文件，包含数据源、端口、日志、JWT、MyBatis Plus 配置。环境区分通过 `spring.profiles.active` 控制。 |
| src/main/resources/mapper/ | 存放 XML 映射文件（目前由 MyBatis Plus 注解实现，目录用于扩展复杂 SQL）。 |
| upload/ | 运行期创建的物理上传目录，配合 `FileStorageProperties` 使用。 |

## 3. 关键配置说明

- **构建（pom.xml）**：引入 Spring Boot、Spring Security、MyBatis Plus、jjwt、Knife4j、Hutool、Lombok 等依赖；`spring-boot-maven-plugin` 负责打包；属性段统一管理版本号，避免多处维护。
- **应用配置（application.yml）**：集中描述数据源、序列化、文件上传大小限制、日志级别；MyBatis Plus 段开启驼峰映射与逻辑删除；JWT 段定义密钥、过期时间、请求头；`server.port` 与 `context-path` 控制 API 地址。
- **安全配置（SecurityConfig + JwtAuthenticationTokenFilter）**：
  - `SecurityConfig` 关闭会话，声明白名单（登录、注册、Knife4j、静态资源）。
  - `JwtAuthenticationTokenFilter` 在每次请求中解析 Token，构建 `UsernamePasswordAuthenticationToken` 注入上下文。
  - 密码加密统一使用 `BCryptPasswordEncoder`，与用户表中密文保持一致。
- **MyBatis Plus 配置**：分页插件保障 `Page` 查询可用；逻辑删除字段 `del_flag` 与数据库保持一致；Mapper 接口放在 `com.approval.module.**.mapper` 下即可被扫描。

## 4. 业务模块职责

- **认证模块（auth）**：
  - 处理登录、注册、Token 刷新；
  - 负责将用户岗位、权限打包给前端，以便控制菜单；
  - 结合 `JwtUtils` 实现自定义过期策略与黑名单预留。
- **系统管理模块（system）**：
  - 提供组织架构、岗位、权限、用户的全生命周期管理；
  - `AdminServiceImpl` 通过事务保证多表更新一致；
  - `FileController` 管理上传文件的生命周期，与审批附件共用存储策略。
- **审批模块（approval）**：
  - `ApplicationController` 负责发起人侧流程（新增、撤回、查询）；
  - `TaskController` 负责审批人动作（签收、通过、驳回、转交）；
  - `AdminApplicationController` 负责管理员总览（跨部门检索、导出报表）；
  - VO 层面为前端提供定制化数据结构以避免重复拼装。

## 5. 开发与协作规范

- **命名**：类使用 PascalCase，方法/属性 camelCase，常量全大写下划线，包全小写。
- **分层**：Controller 仅承载协议转换与调用 Service；Service 负责业务编排与事务；Mapper 负责数据库交互；VO/DTO 负责输入输出模型隔离。
- **异常处理**：所有受控异常统一抛出 `BusinessException` 并由 `GlobalExceptionHandler` 包装；非受控异常记录 ERROR 日志后继续抛出便于外层监控。
- **日志**：关键审批操作需记录 INFO 日志（包含用户、单号、动作）；大批量查询建议在 DEBUG 级别输出筛选条件。
- **安全**：任何需要岗位/权限控制的接口均使用 `@PreAuthorize` 或自定义注解，以岗位权限为主轴进行校验。

## 6. 测试与验证

- 单元测试：在 `src/test/java` 下按模块创建测试类，推荐使用 Mockito 模拟 Mapper 层，重点验证审批流分支逻辑。
- 集成测试：通过 SpringBootTest 启动内嵌容器，联调认证、审批两个模块接口，配合 `sql/02-init-data.sql` 初始化测试数据。
- 接口文档：Knife4j 自动收集 `@Operation` 注解，访问 `/doc.html` 可进行在线调试。

## 7. 部署指引

- **打包**：执行 `mvn clean package -DskipTests` 生成 `target/approval-system-1.0.0.jar`。
- **运行**：`java -jar approval-system-1.0.0.jar --spring.profiles.active=prod`，同时通过 `--Dfile.storage.root=/data/upload` 等参数覆盖存储路径。
- **环境变量**：
  1. `SPRING_DATASOURCE_URL` / `USERNAME` / `PASSWORD`；
  2. `JWT_SECRET`：生产环境务必覆盖；
  3. `FILE_STORAGE_ROOT`：与前端上传路径保持一致。

---

> 📅 **文档版本**：v1.1  
> 📝 **最后更新**：2026-01-20  
> 👤 **编写人**：后端开发工程师
